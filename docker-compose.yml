services:
  postgres:
    image: postgres:15-alpine
    container_name: nsb_postgres
    environment:
      POSTGRES_DB: nsb
      POSTGRES_USER: nsb
      POSTGRES_PASSWORD: nsb
    healthcheck:
      test: [ "CMD", "pg_isready", "-U", "nsb" ]
      interval: 5s
      timeout: 3s
      retries: 20
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      - nsb_net

  backend:
    build:
      context: .
      dockerfile: ./docker/backend/Dockerfile
    container_name: nsb_backend
    env_file: .env
    environment:
      NODE_ENV: production
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - backend_uploads:/app/uploads
    expose:
      - "4000"
    networks:
      - nsb_net

  frontend-build:
    build:
      context: .
      dockerfile: ./docker/frontend/Dockerfile
    container_name: nsb_frontend_build
    environment:
      # важно: Vite читает это во время билдa
      VITE_API_BASE: /api
    # сборка фронта и копирование артефактов в общий volume
    command: [ "sh", "-lc", "yarn build && mkdir -p /dist && cp -r dist/* /dist/" ]
    volumes:
      - frontend_dist:/dist
    depends_on:
      - backend
    networks:
      - nsb_net

  nginx:
    image: nginx:1.25
    container_name: nsb_nginx
    volumes:
      - frontend_dist:/usr/share/nginx/html
      - ./docker/nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "8080:80"
    depends_on:
      - backend
      - frontend-build
    networks:
      - nsb_net

volumes:
  pgdata:
  backend_uploads:
  frontend_dist:


networks:
  nsb_net:
    driver: bridge
